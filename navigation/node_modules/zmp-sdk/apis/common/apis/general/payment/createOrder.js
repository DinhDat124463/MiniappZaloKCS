import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import t from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import r from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import o from"../../../token.js";import n from"../../../../utils/query-string.js";import{apiResponse as s}from"../../../../utils/response.js";import{PAYMENT_H5_URL as a,PAYMENT_APIS as c,APP_ID as i}from"../../../../constants.js";import p from"../openWebview.js";import{MPEEmitter as d}from"../../../eventEmitter.js";import m from"./checkTransaction.js";import{__generator as u}from'./../../../../external/tslib/tslib.es6.js';import{Events as l}from"../../../../types/enum.js";var f,h=(f=e((function(f,h,j,w,I,g){var _,b,y,R,v,O,C,S,P,A,E,T,U,N,k;return u(this,(function(z){switch(z.label){case 0:_=i,(b=new URLSearchParams).append("amount",f.toString()),b.append("item",encodeURIComponent(JSON.stringify(h))),b.append("appId",_),j&&b.append("desc",encodeURIComponent(j)),w&&(y=w,"object"==typeof w&&(y=JSON.stringify(w)),b.append("extradata",encodeURIComponent(y))),I&&(R=I,"object"==typeof I&&(R=JSON.stringify(I)),b.append("payload",encodeURIComponent(R))),g&&b.append("method",g),v={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},z.label=1;case 1:return z.trys.push([1,6,,7]),[4,o.getAccessToken().catch((function(){throw s.error.loginRequired}))];case 2:return O=z.sent(),v.headers.authorization="Bearer ".concat(O),[4,fetch(c.CREATE_ORDER,r(t({method:"POST"},v),{body:b}))];case 3:return[4,z.sent().json()];case 4:if(!(C=z.sent()).data||0!==C.err)throw s.error.badRequest(C.msg);return S=C.data.id,P=C.data.jwt,A=window.APP_VERSION,E=window.APP_ENV,T={miniAppId:_,orderId:S},P&&(T.token=P),A&&(T.version=A),E&&(T.env=E),g&&(T.method=g),U=n.encode(T),N=new URL("?".concat(U),a).toString(),[4,p(N).then((function(){var o=!1;d.getInstance().once(l.WebviewClosed,(function(){setTimeout(e((function(){var e;return u(this,(function(n){switch(n.label){case 0:return o?[3,2]:(console.log("orderId",S),[4,m({zmpOrderId:S})]);case 1:(e=n.sent()).err>=0&&d.getInstance().emit(l.PaymentClose,e.err,r(t({},e),{zmpOrderId:S})),n.label=2;case 2:return[2]}}))})),500)})),d.getInstance().once(l.OpenApp,(function(){o=!0}))}))];case 5:return z.sent(),[2,{orderId:S}];case 6:throw k=z.sent(),console.log("Internal error"),k;case 7:return[2]}}))})),function(e,t,r,o,n,s){return f.apply(this,arguments)});export{h as default};
